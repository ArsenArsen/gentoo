From 8afaeb1869c2d71614b8fefd20279ac5ec450212 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Arsen=20Arsenovi=C4=87?= <arsen@gentoo.org>
Date: Sun, 9 Apr 2023 16:04:27 +0200
Subject: [PATCH] cmake: Try guile and guild executables from guile-N.N.pc
 first

---
https://github.com/Gnucash/gnucash/pull/1601
 CMakeLists.txt | 30 ++++++++++++++++++++++++------
 1 file changed, 24 insertions(+), 6 deletions(-)

diff --git a/CMakeLists.txt b/CMakeLists.txt
index 4a3d01f80f..f72ac40213 100644
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -290,12 +290,18 @@ if (GUILE3_FOUND) # found guile-3.0
   set(GUILE_EFFECTIVE_VERSION 3.0)
   set(GUILE_INCLUDE_DIRS ${GUILE3_INCLUDE_DIRS})
   set(GUILE_LDFLAGS ${GUILE3_LDFLAGS})
-  find_program (GUILD_EXECUTABLE NAMES guild3.0 guild)
+  pkg_get_variable (GUILD_EXECUTABLE guile-3.0 guild)
+  pkg_get_variable (GUILE_EXECUTABLE guile-3.0 guile)
+  if (NOT GUILD_EXECUTABLE)
+    find_program (GUILD_EXECUTABLE NAMES guild3.0 guild)
+  endif()
   if (NOT GUILD_EXECUTABLE)
     message (SEND_ERROR "The guild executable was not found, but is required. Please set GUILD_EXECUTABLE.")
   endif()
   message(STATUS "Using guile-3.0.x")
-  find_program (GUILE_EXECUTABLE NAMES guile3.0 guile)
+  if (NOT GUILE_EXECUTABLE)
+    find_program (GUILE_EXECUTABLE NAMES guile3.0 guile)
+  endif()
 
 elseif (GUILE22_FOUND) # found guile-2.2
   add_definitions (-DHAVE_GUILE22)
@@ -303,12 +309,18 @@ elseif (GUILE22_FOUND) # found guile-2.2
   set(GUILE_EFFECTIVE_VERSION 2.2)
   set(GUILE_INCLUDE_DIRS ${GUILE22_INCLUDE_DIRS})
   set(GUILE_LDFLAGS ${GUILE22_LDFLAGS})
-  find_program (GUILD_EXECUTABLE NAMES guild2.2 guild)
+  pkg_get_variable (GUILD_EXECUTABLE guile-2.2 guild)
+  pkg_get_variable (GUILE_EXECUTABLE guile-2.2 guile)
+  if (NOT GUILD_EXECUTABLE)
+    find_program (GUILD_EXECUTABLE NAMES guild2.2 guild)
+  endif()
   if (NOT GUILD_EXECUTABLE)
     message (SEND_ERROR "The guild executable was not found, but is required. Please set GUILD_EXECUTABLE.")
   endif()
   message(STATUS "Using guile-2.2.x")
-  find_program (GUILE_EXECUTABLE NAMES guile2.2 guile)
+  if (NOT GUILE_EXECUTABLE)
+    find_program (GUILE_EXECUTABLE NAMES guile2.2 guile)
+  endif()
 
 elseif (GUILE2_FOUND) # found guile-2.0
   add_definitions (-DHAVE_GUILE20)
@@ -316,12 +328,18 @@ elseif (GUILE2_FOUND) # found guile-2.0
   set(GUILE_EFFECTIVE_VERSION 2.0)
   set(GUILE_INCLUDE_DIRS ${GUILE2_INCLUDE_DIRS})
   set(GUILE_LDFLAGS ${GUILE2_LDFLAGS})
-  find_program (GUILD_EXECUTABLE NAMES guild2.0 guild)
+  pkg_get_variable (GUILD_EXECUTABLE guile-2.0 guild)
+  pkg_get_variable (GUILE_EXECUTABLE guile-2.0 guile)
+  if (NOT GUILD_EXECUTABLE)
+    find_program (GUILD_EXECUTABLE NAMES guild2.0 guild)
+  endif()
   if (NOT GUILD_EXECUTABLE)
     message (SEND_ERROR "The guild executable was not found, but is required. Please set GUILD_EXECUTABLE.")
   endif()
   message(STATUS "Using guile-2.0.x")
-  find_program (GUILE_EXECUTABLE NAMES guile2.0 guile)
+  if (NOT GUILE_EXECUTABLE)
+    find_program (GUILE_EXECUTABLE NAMES guile2.0 guile)
+  endif()
 
 else()
   message (FATAL_ERROR "Neither guile 3.0, guile 2.2, nor guile 2.0 were found GnuCash can't run without one of them. Ensure that one is installed and can be found with pkg-config.")
-- 
2.40.0

